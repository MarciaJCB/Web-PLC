<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    .slider {
        width: 100%;
        height: 700px;
        overflow: hidden;
        position: relative;
    }

    .slides {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .slide {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0;
        transition: opacity .8s ease;
    }

    .slide.active {
        opacity: 1;
        z-index: 2;
    }
/*
    .slide:before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1;
        background: linear-gradient(to right, hsla(0, 0%, 0%, 1) 0%, hsla(0, 0%, 0%, .3) 100%)
    } */

    .slide:before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1;
    /* --- CÓDIGO MODIFICADO --- */
    background: linear-gradient(
        45deg, /* Dirección Diagonal*/
        hsla(0, 0%, 0%, 0.8) 0%, 
        hsla(0, 0%, 0%, 0.002) 80%
    );
    background-size: 100%!important;
} 

    .slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scale(1.1);
        transition: transform 8s ease;
    }

    .slide.active img {
        transform: scale(1);
    }

    /* wrapper y iframe para cubrir SIEMPRE sin barras negras */
    .youtube-video-container {
        position: absolute;
        inset: 0;
        overflow: hidden;
        z-index: 0;
    }

    .youtube-iframe-wrapper {
        position: absolute;
        inset: 0;
        /* ocupa todo el slide */
        overflow: hidden;
    }

    /* El iframe se centra; su tamaño esta seteado por JS para “cover” */
    .youtube-iframe {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        /* Con esto se evita parpadeo al cargar antes del resize */
        width: 100%;
        height: 100%;
    }

    .youtube-iframe iframe {
        display: block;
    }

    .youtube-overlay {
        position: absolute;
        inset: 0;
        z-index: 2;
        pointer-events: none;
        background: rgba(0, 0, 0, .2);
    }

    .slide-info {
        width: 1100px;
        position: absolute;
        left: 50%;
        bottom: 100px;
        transform: translate(-50%, 0);
        z-index: 3;
    }

    .slide-info h2 {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #fff;
        margin: 0;
        margin-bottom: 16px;
        width: 70%;
        font-size: 48px;
        text-wrap: balance;
        line-height: 1.3em;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity .8s, transform .8s;
        transition-delay: .3s;
    }

    .slide-info p {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #fff;
        margin: 0 0 24px 0;
        width: 70%;
        font-size: 24px;
        text-wrap: balance;
        line-height: 1.5em;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity .8s, transform .8s;
        transition-delay: .6s;
    }

    .slide-info a {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #fff;
        text-decoration: none;
        background: #ffa200;
        padding: 4px 20px;
        display: flex;
        width: max-content;
        justify-content: center;
        border-radius: 50px;
        text-transform: uppercase;
        font-weight: 700;
        font-size: 24px;
        margin: 0 0 32px 0;
        opacity: 0;
        transform: translateY(20px);
        transition:
            background-color .2s 0s,
            /* propiedad, duracion, delay */
            transform .8s .9s,
            opacity .8s .9s;
        /* transition: background-color .2s, transform .8s, opacity .8s ; */
        /* transition-delay: .9s; */
    }

    .slide-info a:hover {
        background-color: #359A30;
    }

    .slide-info a svg {
        width: 32px;
    }

    .slide.active .slide-info h2,
    .slide.active .slide-info p,
    .slide.active .slide-info a {
        opacity: 1;
        transform: translateY(0);
    }

    .navigation-manual {
        position: absolute;
        width: 1100px;
        left: 50%;
        transform: translateX(-50%);
        bottom: 64px;
        display: flex;
        justify-content: flex-start;
        z-index: 4;
    }

    .manual-btn {
        border: 2px solid #fff;
        padding: 5px;
        border-radius: 10px;
        cursor: pointer;
        transition: 1s;
    }

    .manual-btn:not(:last-child) {
        margin-right: 40px;
    }

    .manual-btn.active {
        background: #fff;
    }

    .slider-controls {
        position: absolute;
        top: 50%;
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 4;
        transform: translateY(-50%);
    }

    .control-btn {
        background: rgba(44, 62, 80, .7);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 18px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        transition: background-color .3s;
    }

    .control-btn:hover {
        background: rgba(52, 152, 219, .9);
    }

    .loading,
    .error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .loading {
        text-align: center;
        font-size: 1.2rem;
        color: #7f8c8d;
        padding: 40px;
        width: 100%;
    }

    .error {
        text-align: center;
        color: #e74c3c;
        padding: 40px;
        background: #fadbd8;
        border-radius: 10px;
        margin: 20px;
        width: 80%;
    }

    @media (max-width:1150px) {

        .slider,
        .slide {
            height: 50vh;
        }

        .slide .slide-info,
        .navigation-manual {
            width: 90%;
        }

        .slide-info h2,
        .slide-info p {
            width: 60%;
        }

        .slide-info h2 {
            font-size: 28px;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .slide-info p {
            font-size: 16px;
            line-height: 1.5;
        }

        .slide-info a {
            font-size: 16px;
        }

        .slide-info a svg {
            width: 20px;
        }
    }

    @media (max-width:767px) {

        .slider,
        .slide {
            height: 50vh;
        }

        .slide .slide-info,
        .navigation-manual {
            width: 90%;

        }

        .manual-btn:not(:last-child) {
        margin-right: 20px;
        }

        .slide-info h2,
        .slide-info p {
            width: 70%;
        }

        .slide-info h2 {
            font-size: 16px;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .slide-info p {
            font-size: 12px;
            line-height: 1.5;
        }

        .slide-info a {
            font-size: 12px;
        }

        .slide-info a svg {
            width: 16px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
    }
</style>

<div id="app">
    <div class="slider">
        <div v-if="error" class="error">
            <h2>Error al cargar los banners</h2>
            <p>{{ error }}</p>
            <p>Verifica que el endpoint de la API sea correcto y accessible.</p>
        </div>

        <div v-else-if="loading" class="loading">Cargando banners...</div>

        <div v-else class="slides">
            <div v-for="(banner, index) in banners" :key="banner.id"
                :class="['slide', { active: currentIndex === index }]">

                <img v-if="banner.acf && banner.acf.tipo_de_fondo === 'fondo-imagen'" :src="banner.acf.Imagen"
                    :alt="banner.title.rendered">

                <div v-else-if="banner.acf && banner.acf.tipo_de_fondo === 'fondo-video'"
                    class="youtube-video-container">
                    <div class="youtube-iframe-wrapper" :data-banner-id="banner.id">
                        <!-- YouTube inyecta el iframe aquí -->
                        <div :id="'player-'+banner.id" class="youtube-iframe"></div>
                    </div>
                    <div class="youtube-overlay"></div>
                </div>

                <div class="slide-info">
                    <h2>{{ banner.title.rendered }}</h2>
                    <p>{{ banner.acf.Bajada_de_titulo }}</p>
                    <a :href="banner.acf.Boton" target="_blank">
                        {{ banner.acf.texto_del_boton || 'Conoce más' }}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M13.1717 12.0007L8.22192 7.05093L9.63614 5.63672L16.0001 12.0007L9.63614 18.3646L8.22192 16.9504L13.1717 12.0007Z">
                            </path>
                        </svg>
                    </a>
                </div>
            </div>

            <div class="navigation-manual">
                <span v-for="(banner, index) in banners" :key="'dot-'+banner.id"
                    :class="['manual-btn', { active: currentIndex === index }]" @click="goToSlide(index)"></span>
            </div>

            <div class="slider-controls">
                <button class="control-btn" @click="prevSlide">&#10094;</button>
                <button class="control-btn" @click="nextSlide">&#10095;</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, onUnmounted } = Vue;

    let youtubePlayers = {};            // id -> YT.Player
    let resizeObservers = {};           // por wrapper

    const app = createApp({
        setup() {
            const banners = ref([]); //Lista de banners desde la API
            const loading = ref(true);//Estado de carga
            const error = ref(null);//Mensaje de error si ocurre
            const apiEndpoint = ref('https://padrelascasas.cl/nuevositio/wp-json/wp/v2/banner');//Endpoint de la API
            const currentIndex = ref(0);//Indice del banner actual
            const intervalId = ref(null);//Id del intervalo de auto-slide

            let sliderVisible = true;
            let pageVisible = true;

            const getYouTubeId = (url) => {
                if (!url) return null;
                const r = /^.*(?:youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]{11}).*/;
                const m = url.match(r); return m ? m[1] : null;
            };

            /* getVideoRatio: lee ACF.aspect_ratio o infiere */
            const parseRatio = (str) => {
                // "16:9" => 16/9
                const m = /^(\d+)\s*:\s*(\d+)$/.exec(String(str || '').trim());
                if (!m) return null;
                const a = parseFloat(m[1]), b = parseFloat(m[2]);
                return (a > 0 && b > 0) ? (a / b) : null;
            };
            const getVideoRatio = (banner) => {
                if (!banner?.acf) return 16 / 9;
                const ar = parseRatio(banner.acf.aspect_ratio);
                if (ar) return ar;
                const url = banner.acf.video_youtube_de_fondo || '';
                if (banner.acf.es_vertical === true || url.includes('/shorts/')) return 9 / 16;
                return 16 / 9; // por defecto
            };

            /* cover por proporciones en tiempo real (wrapper vs video) */
            const resizeIframeCover = (wrapperEl) => {
                if (!wrapperEl) return;
                // el iframe lo inyecta YT dentro del div.youtube-iframe
                const iframe = wrapperEl.querySelector('iframe');
                if (!iframe) return;

                const W = wrapperEl.clientWidth;
                const H = wrapperEl.clientHeight;
                const bannerId = wrapperEl.getAttribute('data-banner-id');
                const b = (Array.isArray(banners.value) ? banners.value.find(x => String(x.id) === String(bannerId)) : null);
                const Rvideo = getVideoRatio(b);         // ej: 16/9 ó 9/16

                const Rcontainer = W / H;
                let w, h;
                if (Rcontainer > Rvideo) {
                    // contenedor más “ancho” que el video → expandir por alto (overflow top/bottom)
                    w = W;
                    h = W / Rvideo;
                } else {
                    // contenedor más “alto” que el video → expandir por ancho (overflow left/right)
                    h = H;
                    w = H * Rvideo;
                }
                iframe.style.width = w + 'px';
                iframe.style.height = h + 'px';
            };

            /* si cambia su tamaño/aspecto, recalcula */
            const observeWrapperResize = (wrapperEl) => {
                if (!wrapperEl || resizeObservers[wrapperEl.dataset.bannerId]) return;
                const ro = new ResizeObserver(() => resizeIframeCover(wrapperEl));
                ro.observe(wrapperEl);
                resizeObservers[wrapperEl.dataset.bannerId] = ro;
            };

            /* espera a que YT inserte el iframe para poder dimensionarlo */
            const waitForIframeThenResize = (wrapperEl) => {
                if (!wrapperEl) return;
                const existing = wrapperEl.querySelector('iframe');
                if (existing) { resizeIframeCover(wrapperEl); observeWrapperResize(wrapperEl); return; }
                const mo = new MutationObserver(() => {
                    const ifr = wrapperEl.querySelector('iframe');
                    if (ifr) {
                        resizeIframeCover(wrapperEl);
                        observeWrapperResize(wrapperEl);
                        mo.disconnect();
                    }
                });
                mo.observe(wrapperEl, { childList: true, subtree: true });
            };

            const pauseAllVideos = () => {
                for (const id in youtubePlayers) {
                    try { youtubePlayers[id]?.pauseVideo && youtubePlayers[id].pauseVideo(); } catch (_) { }
                }
            };
            const playIfVideo = (index) => {
                const b = banners.value[index];
                if (!(b?.acf && b.acf.tipo_de_fondo === 'fondo-video')) return;
                const playerId = 'player-' + b.id;
                const p = youtubePlayers[playerId];
                if (p) { try { p.playVideo && p.playVideo(); } catch (_) { } }
            };

            const initYouTubePlayer = (banner) => {
                if (!banner.acf || banner.acf.tipo_de_fondo !== 'fondo-video') return;
                const videoId = getYouTubeId(banner.acf.video_youtube_de_fondo);
                if (!videoId) return;

                const playerId = 'player-' + banner.id;// id del contenedor que youtube usara
                if (typeof YT !== 'undefined' && YT.Player) {// asegura que la API de YTB este cargada
                    youtubePlayers[playerId] = new YT.Player(playerId, {// crea la instancia del play de YTB
                        videoId,
                        playerVars: {
                            autoplay: 1, controls: 0, rel: 0, modestbranding: 1, loop: 1, playlist: videoId,
                            mute: 1, iv_load_policy: 3, disablekb: 1, fs: 0, enablejsapi: 1, playsinline: 1
                        },
                        events: {
                            onReady: (e) => {
                                e.target.mute(); e.target.playVideo();
                                // ajustar cover para este wrapper apenas aparezca el iframe
                                const wrapperEl = document.querySelector(`.youtube-iframe-wrapper[data-banner-id="${banner.id}"]`);
                                setTimeout(() => waitForIframeThenResize(wrapperEl), 30);
                            },
                            onStateChange: (e) => { if (e.data === YT.PlayerState.ENDED) e.target.playVideo(); }
                        }
                    });
                }
            };

            const initAllYouTubePlayers = () => {
                banners.value.forEach(b => initYouTubePlayer(b));
                // resize inicial por si ya hay iframes inyectados
                setTimeout(() => {
                    document.querySelectorAll('.youtube-iframe-wrapper').forEach(waitForIframeThenResize);
                    pauseAllVideos();
                    playIfVideo(currentIndex.value);
                }, 150);
            };

            const fetchBanners = async () => {// funcion para obtener los banners desde la API
                try {
                    const { data } = await axios.get(apiEndpoint.value);// realiza la peticion GET
                    banners.value = data;//actualiza la lista de banners
                    loading.value = false;//carga completa
                    setTimeout(initAllYouTubePlayers, 200);//inicializa los players de youtube
                    startAutoSlide();//inicia el auto slide
                } catch (err) {//manejo de errores
                    error.value = err.message;
                    loading.value = false;
                    console.error(err);
                }
            };

            const stopAutoSlide = () => { if (intervalId.value) { clearInterval(intervalId.value); intervalId.value = null; } };
            const goTo = (i) => {
                stopAutoSlide();
                pauseAllVideos();
                currentIndex.value = i;//cambia de slide actual
                if (pageVisible && sliderVisible) playIfVideo(i);
                setTimeout(startAutoSlide, 5000);
            };
            const nextSlide = () => goTo((currentIndex.value + 1) % banners.value.length);
            const prevSlide = () => goTo(currentIndex.value === 0 ? banners.value.length - 1 : currentIndex.value - 1);
            const goToSlide = (i) => goTo(i);
            const startAutoSlide = () => { stopAutoSlide(); intervalId.value = setInterval(nextSlide, 5000); };

            const setupVisibilityGuards = () => {
                const onVis = () => {
                    pageVisible = (document.visibilityState === 'visible');
                    if (pageVisible && sliderVisible) { pauseAllVideos(); playIfVideo(currentIndex.value); }
                    else { pauseAllVideos(); }
                };
                document.addEventListener('visibilitychange', onVis);

                const sliderEl = document.querySelector('.slider');
                let io;
                if (sliderEl && 'IntersectionObserver' in window) {
                    io = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            sliderVisible = entry.isIntersecting && entry.intersectionRatio > 0.2;
                            if (pageVisible && sliderVisible) { pauseAllVideos(); playIfVideo(currentIndex.value); }
                            else { pauseAllVideos(); }
                        });
                    }, { threshold: [0, 0.2, 0.5, 1] });
                    io.observe(sliderEl);
                }
                return () => { document.removeEventListener('visibilitychange', onVis); io && io.disconnect(); };
            };

            onMounted(() => { //configuracion inicial de Youtube API y carga de banners
                window.onYouTubeIframeAPIReady = () => { if (banners.value.length) initAllYouTubePlayers(); };//inicializa YT API
                fetchBanners();//carga inicial de banners

                // si cambia el tamaño de la ventana, recalcula todos
                window.addEventListener('resize', () => {
                    document.querySelectorAll('.youtube-iframe-wrapper').forEach(resizeIframeCover);
                }, { passive: true });//recalcula el tamaño de los iframes al redimensionar

                app._cleanupVis = setupVisibilityGuards();// guarda la funcion de limpieza
            });

            onUnmounted(() => {//LIMPIEZA AL DESTRUIR COMPONENTE (vista fuera de pantalla) evita carga innecesaria
                stopAutoSlide();//esto es para detener el auto slide 
                window.removeEventListener('resize', () => { });//remueve el listener de resize
                app._cleanupVis && app._cleanupVis();// remueve la vigilancia de visibilidad

                // cierra observadores
                Object.values(resizeObservers).forEach(ro => { try { ro.disconnect(); } catch (_) { } });
                resizeObservers = {};
                //destruye los player de youtube esto sirve para liberar memoria y recursos
                for (const id in youtubePlayers) {
                    try { youtubePlayers[id]?.destroy && youtubePlayers[id].destroy(); } catch (_) { }
                }
                youtubePlayers = {};//asigna un objeto vacio para liberar referencias 
            });

            return { banners, loading, error, currentIndex, prevSlide, nextSlide, goToSlide };//expone variables y funciones 
        }
    });

    app.mount('#app');
</script>